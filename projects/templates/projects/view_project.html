{% extends 'layout/user.html' %}
{% load static bootstrap3 chameleon_tags %}
{% block title %}Project - {{ project.chargeCode }}{% endblock %}
{% block content %}
{% if can_manage_project %}
<a href="/user/projects/add/publications/{{project.id}}" class="btn btn-info pull-right">
  <i class="fa fa-plus-circle"></i> Add Publications
</a>
{% endif %}
<h2>
  {{ project.title }} |
  <small>{{ project.chargeCode }}</small>
</h2>

<div class="table-responsive">
  <table class="table">
    <tbody>
      <tr>
        <th>PI</th>
        <td>
        {% if is_admin %}
          {{ project.pi.firstName }} {{ project.pi.lastName }} <a href="mailto:{{ project.pi.email }}">&lt;{{ project.pi.email }}&gt;</a>
          {% if project.pi.institution %}{{ project.pi.institution}}{% endif %}
          <span id='icon_show_pi_edit' title="Edit" style="padding-left: 5px;" class="glyphicon glyphicon-edit"></span>
          <span id='project_pi_edit_form' class='hidden'>
          <form method="POST" id='project_pi_edit_form' name='frm_edit_pi'>
          {% csrf_token %}
          {% bootstrap_form pi_form %}
          <button type="submit" class="btn btn-xs" id="btn_update_project_pi">Update</button>
          <button type="button" class="btn btn-xs" id="btn_pi_cancel">Cancel</button>
          </form>
          </span>
        {% else %}
          {{ project.pi.firstName }} {{ project.pi.lastName }} <a href="mailto:{{ project.pi.email }}">&lt;{{ project.pi.email }}&gt;</a>
          {% if project.pi.institution %}{{ project.pi.institution}}{% endif %}
        {% endif %}
        </td>
      </tr>
      <tr>
        <th>Nickname</th>
        <td>
          {% if can_manage_project %}
            <span id='project_nickname'>{{ project_nickname|default_if_none:'' }}</span><span id='icon_show_edit' title="Edit" style="padding-left: 5px;" class="glyphicon glyphicon-edit"></span>
            <span id='project_edit_form' class='hidden'>
            <form method="POST" id='frm_edit_nickname' name='frm_edit_nickname'>
              {% csrf_token %}
              {% bootstrap_form nickname_form %}
            <button type="submit" class="btn btn-xs" id="btn_update_project_nickname">Update</button>
            <button type="button" class="btn btn-xs" id="btn_cancel">Cancel</button>
            </form>
          </span>
          {% else %}
            <span id='project_nickname'>{{ project_nickname|default_if_none:'' }}</span>
          {% endif %}
          </td>
      </tr>
      <tr>
        <th>Abstract</th>
        <td style="white-space:pre-wrap;">{{ project.description }}</td>
      </tr>
      <tr>
        <th>Tag</th>
        <td>
          {% if can_manage_project %}
            <span id='project_tag'>{{ project_tag|default_if_none:'' }}</span><span id='icon_show_type_edit' title="Edit" style="padding-left: 5px;" class="glyphicon glyphicon-edit"></span>
            <span id='project_tag_edit_form' class='hidden'>
            <form method="POST" id='project_tag_edit_form' name='frm_edit_type'>
              {% csrf_token %}
              {% bootstrap_form tag_form %}
            <button type="submit" class="btn btn-xs" id="btn_update_project_tag">Update</button>
            <button type="button" class="btn btn-xs" id="btn_type_cancel">Cancel</button>
            </form>
          </span>
          {% else %}
            <span id='project_tag'>{{ project_tag|default_if_none:'' }}</span>
          {% endif %}
        </td>
      </tr>
    </tbody>
  </table>
</div>

<h3>Allocations</h3>
<div class="allocations">
  {% if project.has_inactive_allocations %}
    <button class="btn btn-xs btn-default pull-right" name="allocation-display-toggle">Toggle inactive allocations</button>
  {% endif %}

  {% if not project.has_active_allocations and not project.has_approved_allocations and not project.has_pending_allocations %}
      <div class="alert alert-info">
        <h4>No current allocations</h4>
        <p>
          You don't have any current allocations. This could be because your allocation
          recently expired or your project is new and you have not requested one yet.
          Please click on the <b>Request Allocation</b> below to get started!
        </p>
      </div>
      <a class="btn btn-primary btn-sm" href="{% url 'projects:create_allocation' project.id %}">
        <i class="fa fa-plus"></i>
        Request Allocation
      </a>
  {% endif %}

  <table width=100%>
    <tr>
      <th width=10%>Status</th>
      <th width=15%>Date Requested</th>
      <th width=15%>Date Reviewed</th>
      <th width=15%>Start On</th>
      <th width=15%>End On</th>
      <th width=25%>Usage</th>
      <th width=5%></th>
    </tr>
    {% for alloc in project.active_allocations %}
      {% include 'projects/allocation.html' %}
    {% endfor %}
    {% for alloc in project.approved_allocations %}
      {% include 'projects/allocation.html' %}
    {% endfor %}
    {% for alloc in project.pending_allocations %}
      {% include 'projects/allocation.html' %}
    {% endfor %}
    {% for alloc in project.waiting_allocations %}
      {% include 'projects/allocation.html' %}
    {% endfor %}
    {% for alloc in project.rejected_allocations %}
      {% include 'projects/allocation.html' %}
    {% endfor %}
    {% for alloc in project.inactive_allocations %}
      {% include 'projects/allocation.html' %}
    {% endfor %}
  </table>

  {% include "projects/charge_modal.html" %}
</div>

<h3>Project Members</h3>

{% if can_manage_project_membership %}
<form class="form-inline" role="form" method="post">
  {% csrf_token %}
  {% bootstrap_form form %}
  <div class="form-group">
    <button type="submit" class="btn btn-default" name="add_user">Add user</button>
    <button class="btn btn-default" name="add_bulk_users_popup">Add multiple users</button>
    <button class="btn btn-danger" name="remove_bulk_users_popup">Remove multiple users</button>
  </div>
</form>
{% include "projects/bulk_invite_modal.html" %}
{% include "projects/bulk_remove_modal.html" %}
{% endif %}

<br>
<br>
<table width=100%>
  <tr>
    <th>Username</th>
    <th>First Name</th>
    <th>Last Name</th>
    <th>Email</th>
    <th>Role</th>
    <th></th>
  </tr>
  {% for join_request in join_requests %}
  <tr>
    <td>{{ join_request.user.username }}</td>
    <td>{{ join_request.user.first_name }}</td>
    <td>{{ join_request.user.last_name }}</td>
    <td>{{ join_request.user.email }}</td>
    <td>
      <i>Requested to join</i>
    </td>
    <td>
      {% if can_manage_project_membership %}
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="joinRequestDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fa fa-gear text-info dropbtn"></i><span class="sr-only">Respond to Request</span>
        </button>
        <div class="dropdown-menu dropdown-content" aria-labelledby="joinRequestDropdown">
          <form method="post" style="display:inline">
            {% csrf_token %}
            <input type="hidden" name="join_request" value="{{ join_request.id }}">
            <button type="submit" class="btn btn-xs btn-success btn-block" name="accept_join_request">Accept</button>
            <button type="submit" class="btn btn-xs btn-danger btn-block" name="reject_join_request">Reject</button>
          </form>
        </div>
      </div>
      {% endif %}
    </td>
  </tr>
  {% endfor %}
  {% for u in users %}
  <tr>
    <td>{{ u.username }}</td>
    <td>{{ u.first_name }}</td>
    <td>{{ u.last_name }}</td>
    <td>{{ u.email }}</td>
    <td>
       <form role="form" method="post" style="display:inline">
         {% csrf_token %}
         <input type="hidden" name="user_ref" value="{{ u.username }}">
         <select id="role_{{ u.id }}" name="user_role" class="form-select role_selector" data-initial="{{ u.role }}" disabled>
           {% for role in roles %}
             <option value="{{ role }}" {% if role == u.role %}selected disabled{% endif %}>{{ role }}</option>
           {% endfor %}
         </select>
         <button type="submit" id="submit_role_{{ u.id }}" class="btn btn-xs btn-primary" name="change_role" style="display:none;">Submit</button>
         <button type="button" onclick="resetRole('role_{{ u.id }}')" id="cancel_role_{{ u.id }}" class="btn btn-xs btn-danger" style="display:none;">Cancel</button>
       </form>
    </td>
    <td>
      {% if u.username != request.user.username %}
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" {% if not can_manage_project_membership %}disabled{%endif%}>
          <i class="fa fa-gear text-info dropbtn"></i><span class="sr-only">Manage Member</span>
        </button>
        <div class="dropdown-menu dropdown-content" aria-labelledby="dropdownMenuButton">
          {% if can_manage_project %}
          <button onclick="enableChangeRole('{{ u.id }}')" class="btn btn-xs btn-block">Change Role</button>
          {% endif %}
          {% if can_manage_project_membership %}
          <form role="form" method="post" style="display:inline">
            {% csrf_token %}
            <input type="hidden" name="user_ref" value="{{ u.username }}">
            <button type="submit" class="btn btn-xs btn-danger btn-block" name="del_user">Remove user</button>
          </form>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </td>
    <td>{% if u.daypass %} Daypass: {{ u.daypass }} remain {% endif %}</td>
  </tr>
  {% endfor %}
  {% for i in invitations %}
  <tr>
    <td>--</td>
    <td>--</td>
    <td>--</td>
    <td>{{ i.email_address }}</td>
    <td>
      Pending Invitation - {{ i.status }}
      {% if i.duration %} ({{ i.duration }} hours) {% endif %}
    </td>
    <td>
    <div class="dropdown">
      <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" {% if not can_manage_project_membership %}disabled{%endif%}>
        <i class="fa fa-gear text-info dropbtn"></i><span class="sr-only">Manage Member</span>
      </button>
      <div class="dropdown-menu dropdown-content" aria-labelledby="dropdownMenuButton">
          {% if can_manage_project_membership %}
          <form role="form" method="post" style="display:inline">
            {% csrf_token %}
            <input type="hidden" name="invite_id" value="{{ i.id }}">
            <button type="submit" class="btn btn-xs btn-block" name="resend_invite">Resend invitation</button>
          </form>
          <form role="form" method="post" style="display:inline">
            {% csrf_token %}
            <input type="hidden" name="invite_id" value="{{ i.id }}">
            <button type="submit" class="btn btn-xs btn-danger btn-block" name="del_invite">Remove invitation</button>
          </form>
          {% endif %}
      </div>
    </div>
    </td>
  </tr>
  {% endfor %}
</table>
<br>
<br>

{% comment %}
{% if project.has_active_allocations %}
<h3>Usage</h3>
{% for alloc in project.active_allocations %}
<div id="usageChart" start="{{alloc.start|date:'Y-m-d'}}" end="{{alloc.end|date:'Y-m-d'}}" allocation-id="{{alloc.id}}" project-id="{{project.id}}" ></div>
{% endfor %}
{% endif %}
{% endcomment %}
{% endblock %}


{% block scripts %}
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="{% static 'projects/js/allocations.js' %}" type="text/javascript"></script>
<script src="{% static 'projects/js/members.js' %}" type="text/javascript"></script>
<script src="{% static 'projects/js/bulk_invite.js' %}" type="text/javascript"></script>
<script src="{% static 'projects/js/bulk_remove.js' %}" type="text/javascript"></script>
{% endblock %}
